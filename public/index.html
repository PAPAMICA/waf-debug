<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAF Debug - Receiver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        dark: { 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        accent: { 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-dark { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
    </style>
</head>
<body class="bg-dark-950 min-h-screen text-dark-100">
    <!-- Navigation -->
    <nav class="glass-dark sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-accent-500 to-accent-600 flex items-center justify-center shadow-lg">
                        <i class="fas fa-satellite-dish text-white text-lg"></i>
                    </div>
                    <div>
                        <span class="text-lg font-semibold text-white">WAF Debug</span>
                        <span class="hidden sm:inline text-dark-400 text-sm ml-2">Request Receiver</span>
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <a href="/" class="px-4 py-2 rounded-lg text-sm font-medium bg-accent-600 text-white">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </a>
                    <a href="/logs" class="px-4 py-2 rounded-lg text-sm font-medium text-dark-300 hover:text-white hover:bg-dark-800 transition-all">
                        <i class="fas fa-scroll mr-2"></i>Logs
                    </a>
                    <a href="/stats" class="px-4 py-2 rounded-lg text-sm font-medium text-dark-300 hover:text-white hover:bg-dark-800 transition-all">
                        <i class="fas fa-chart-bar mr-2"></i>Stats
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-accent-500 to-accent-600 flex items-center justify-center shadow-xl mx-auto mb-4">
                <i class="fas fa-satellite-dish text-white text-3xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">WAF Debug Receiver</h1>
            <p class="text-dark-400">Récepteur de requêtes pour tests WAF</p>
        </div>

        <!-- Instructions -->
        <div class="glass rounded-xl p-6 mb-8">
            <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-play text-emerald-400 text-xl"></i>
                </div>
                <div class="flex-1">
                    <h2 class="text-xl font-semibold text-white mb-3">Comment utiliser</h2>
                    <ol class="space-y-3 text-dark-300">
                        <li class="flex items-start gap-3">
                            <span class="w-6 h-6 rounded-full bg-accent-500/20 text-accent-400 flex items-center justify-center text-sm font-bold flex-shrink-0">1</span>
                            <span>Allez sur <a href="https://waf.secmy.app/" target="_blank" class="text-accent-400 hover:underline font-medium">waf.secmy.app</a></span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="w-6 h-6 rounded-full bg-accent-500/20 text-accent-400 flex items-center justify-center text-sm font-bold flex-shrink-0">2</span>
                            <span>Entrez l'URL de ce serveur comme cible : <code class="bg-dark-800 px-2 py-1 rounded text-accent-300 font-mono text-sm" id="serverUrl"></code></span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="w-6 h-6 rounded-full bg-accent-500/20 text-accent-400 flex items-center justify-center text-sm font-bold flex-shrink-0">3</span>
                            <span>Lancez les tests depuis waf.secmy.app</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="w-6 h-6 rounded-full bg-accent-500/20 text-accent-400 flex items-center justify-center text-sm font-bold flex-shrink-0">4</span>
                            <span>Consultez les <a href="/logs" class="text-accent-400 hover:underline font-medium">logs</a> pour voir les requêtes reçues et celles bloquées par votre WAF</span>
                        </li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="glass rounded-xl p-5 text-center">
                <div class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-inbox text-blue-400 text-xl"></i>
                </div>
                <p id="statTotal" class="text-3xl font-bold text-white font-mono">0</p>
                <p class="text-dark-400 text-sm mt-1">Requêtes reçues</p>
            </div>
            <div class="glass rounded-xl p-5 text-center">
                <div class="w-12 h-12 rounded-xl bg-violet-500/20 flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-network-wired text-violet-400 text-xl"></i>
                </div>
                <p id="statIps" class="text-3xl font-bold text-white font-mono">0</p>
                <p class="text-dark-400 text-sm mt-1">IPs uniques</p>
            </div>
            <div class="glass rounded-xl p-5 text-center">
                <div class="w-12 h-12 rounded-xl bg-amber-500/20 flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-globe text-amber-400 text-xl"></i>
                </div>
                <p id="statCountries" class="text-3xl font-bold text-white font-mono">0</p>
                <p class="text-dark-400 text-sm mt-1">Pays</p>
            </div>
            <div class="glass rounded-xl p-5 text-center">
                <div class="w-12 h-12 rounded-xl bg-rose-500/20 flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-route text-rose-400 text-xl"></i>
                </div>
                <p id="statPaths" class="text-3xl font-bold text-white font-mono">0</p>
                <p class="text-dark-400 text-sm mt-1">Chemins testés</p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <a href="/logs" class="glass rounded-xl p-5 hover:bg-dark-700/50 transition-all group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="fas fa-scroll text-blue-400 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-white">Voir les Logs</h3>
                        <p class="text-dark-400 text-sm">Détails de chaque requête</p>
                    </div>
                </div>
            </a>
            <a href="/stats" class="glass rounded-xl p-5 hover:bg-dark-700/50 transition-all group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="fas fa-chart-pie text-emerald-400 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-white">Statistiques</h3>
                        <p class="text-dark-400 text-sm">Analyses détaillées</p>
                    </div>
                </div>
            </a>
            <button onclick="clearLogs()" class="glass rounded-xl p-5 hover:bg-dark-700/50 transition-all group text-left">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-rose-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="fas fa-trash text-rose-400 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-white">Effacer les Logs</h3>
                        <p class="text-dark-400 text-sm">Réinitialiser les données</p>
                    </div>
                </div>
            </button>
        </div>

        <!-- Live Activity -->
        <div class="glass rounded-xl overflow-hidden">
            <div class="px-6 py-4 border-b border-dark-700/50 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-accent-500/20 flex items-center justify-center">
                        <i class="fas fa-tower-broadcast text-accent-400"></i>
                    </div>
                    <div>
                        <h2 class="font-semibold text-white">Activité en Direct</h2>
                        <p class="text-dark-400 text-sm">Dernières requêtes reçues</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div id="liveIndicator" class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                    <span class="text-emerald-400 text-sm font-medium">Live</span>
                </div>
            </div>
            <div id="liveActivity" class="p-4 space-y-2 max-h-[400px] overflow-y-auto">
                <div class="text-center py-8 text-dark-400">
                    <i class="fas fa-satellite-dish text-4xl mb-3 opacity-50"></i>
                    <p>En attente de requêtes...</p>
                    <p class="text-sm text-dark-500 mt-1">Lancez les tests depuis waf.secmy.app</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="border-t border-dark-800 mt-12">
        <div class="max-w-7xl mx-auto px-4 py-6 flex items-center justify-between">
            <div class="flex items-center gap-2 text-dark-400 text-sm">
                <i class="fas fa-satellite-dish text-accent-500"></i>
                <span>WAF Debug Receiver</span>
            </div>
            <a href="https://waf.secmy.app/" target="_blank" class="text-dark-500 text-sm hover:text-accent-400 transition-colors">
                Tests via waf.secmy.app <i class="fas fa-external-link ml-1"></i>
            </a>
        </div>
    </footer>

    <script>
        // Set server URL
        document.getElementById('serverUrl').textContent = window.location.origin;
        
        let ws;
        let recentLogs = [];

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);
            
            ws.onopen = () => {
                document.getElementById('liveIndicator').classList.add('animate-pulse');
            };
            
            ws.onmessage = (event) => {
                const log = JSON.parse(event.data);
                recentLogs.unshift(log);
                if (recentLogs.length > 20) recentLogs.pop();
                updateLiveActivity();
                loadStats();
            };
            
            ws.onclose = () => {
                document.getElementById('liveIndicator').classList.remove('animate-pulse');
                setTimeout(connectWebSocket, 3000);
            };
        }

        function updateLiveActivity() {
            const container = document.getElementById('liveActivity');
            if (recentLogs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-dark-400">
                        <i class="fas fa-satellite-dish text-4xl mb-3 opacity-50"></i>
                        <p>En attente de requêtes...</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recentLogs.map(log => {
                const time = new Date(log.timestamp).toLocaleTimeString('fr-FR');
                const attacks = log.detectedAttacks || [];
                const methodColors = {
                    'GET': 'bg-blue-500/20 text-blue-400',
                    'POST': 'bg-emerald-500/20 text-emerald-400',
                    'PUT': 'bg-amber-500/20 text-amber-400',
                    'DELETE': 'bg-rose-500/20 text-rose-400'
                };
                const methodColor = methodColors[log.method] || 'bg-dark-600 text-dark-300';
                
                return `
                    <div class="flex items-center gap-3 p-3 bg-dark-800/50 rounded-lg ${attacks.length > 0 ? 'ring-1 ring-rose-500/30' : ''}">
                        <span class="px-2 py-1 rounded ${methodColor} font-mono text-xs font-medium">${log.method}</span>
                        <span class="text-accent-300 font-mono text-sm truncate flex-1" title="${log.url}">${log.url}</span>
                        ${attacks.length > 0 ? `<span class="px-2 py-1 bg-rose-500/20 text-rose-400 rounded text-xs">${attacks[0]}</span>` : ''}
                        <span class="text-dark-500 text-xs font-mono">${time}</span>
                    </div>
                `;
            }).join('');
        }

        function loadStats() {
            fetch('/api/stats')
                .then(res => res.json())
                .then(stats => {
                    document.getElementById('statTotal').textContent = stats.total.toLocaleString();
                    document.getElementById('statIps').textContent = Object.keys(stats.byIp || {}).length;
                    document.getElementById('statCountries').textContent = Object.keys(stats.byCountry || {}).length;
                    document.getElementById('statPaths').textContent = Object.keys(stats.byPath || {}).length;
                });
        }

        function clearLogs() {
            if (confirm('Voulez-vous vraiment effacer tous les logs ?')) {
                fetch('/api/clear-logs', { method: 'POST' })
                    .then(() => {
                        recentLogs = [];
                        updateLiveActivity();
                        loadStats();
                    });
            }
        }

        // Load initial data
        fetch('/api/logs?limit=20')
            .then(res => res.json())
            .then(data => {
                recentLogs = data;
                updateLiveActivity();
            });

        loadStats();
        connectWebSocket();
        setInterval(loadStats, 10000);
    </script>
</body>
</html>
