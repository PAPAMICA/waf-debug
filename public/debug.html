<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAF Debug - Debug Requ√™tes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-gray-900 via-yellow-900 to-gray-900 min-h-screen">
    <nav class="bg-gray-800 border-b border-yellow-500 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl font-bold text-yellow-400">üõ°Ô∏è WAF Debug</span>
                </div>
                <div class="flex space-x-4">
                    <a href="/" class="text-gray-300 hover:text-white px-3 py-2 rounded-md font-medium hover:bg-gray-700">Accueil</a>
                    <a href="/logs" class="text-gray-300 hover:text-white px-3 py-2 rounded-md font-medium hover:bg-gray-700">Logs</a>
                    <a href="/stats" class="text-gray-300 hover:text-white px-3 py-2 rounded-md font-medium hover:bg-gray-700">Stats</a>
                    <a href="/debug" class="text-yellow-300 hover:text-white px-3 py-2 rounded-md font-medium bg-yellow-700">Debug</a>
                    <a href="/tests" class="text-gray-300 hover:text-white px-3 py-2 rounded-md font-medium hover:bg-gray-700">Tests</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-white mb-4">
                <i class="fas fa-bug text-yellow-400"></i> Debug Requ√™tes HTTP
            </h1>
            <p class="text-gray-300">Analysez en d√©tail vos requ√™tes HTTP</p>
        </div>

        <div class="bg-gray-800 rounded-lg p-6 border border-yellow-500 mb-6">
            <h2 class="text-2xl font-bold text-white mb-4">
                <i class="fas fa-paper-plane text-yellow-400 mr-2"></i>
                Envoyer une Requ√™te de Test
            </h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-gray-400 mb-2">M√©thode HTTP</label>
                    <select id="method" class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-400 mb-2">URL</label>
                    <input type="text" id="url" value="/vuln/test" 
                        class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 focus:border-yellow-500 focus:outline-none">
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-gray-400 mb-2">Headers (un par ligne: Nom: Valeur)</label>
                <textarea id="headers" rows="4" 
                    class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 focus:border-yellow-500 focus:outline-none font-mono text-sm"
                    placeholder="User-Agent: Custom Client&#10;X-Custom-Header: test"></textarea>
            </div>

            <div class="mb-4">
                <label class="block text-gray-400 mb-2">Body (JSON)</label>
                <textarea id="body" rows="6" 
                    class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 focus:border-yellow-500 focus:outline-none font-mono text-sm"
                    placeholder='{"key": "value"}'></textarea>
            </div>

            <button onclick="sendRequest()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-semibold">
                <i class="fas fa-play mr-2"></i>Envoyer la Requ√™te
            </button>
        </div>

        <div id="responseSection" class="hidden">
            <div class="bg-gray-800 rounded-lg p-6 border border-green-500 mb-6">
                <h2 class="text-2xl font-bold text-white mb-4">
                    <i class="fas fa-check-circle text-green-400 mr-2"></i>
                    R√©ponse
                </h2>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-gray-700 p-4 rounded">
                        <p class="text-gray-400 text-sm mb-1">Status Code</p>
                        <p id="statusCode" class="text-2xl font-bold text-white">200</p>
                    </div>
                    <div class="bg-gray-700 p-4 rounded">
                        <p class="text-gray-400 text-sm mb-1">Temps de R√©ponse</p>
                        <p id="responseTime" class="text-2xl font-bold text-white">0ms</p>
                    </div>
                </div>

                <div class="mb-4">
                    <h3 class="text-lg font-bold text-white mb-2">Response Headers</h3>
                    <pre id="responseHeaders" class="bg-gray-900 p-4 rounded text-gray-300 text-sm overflow-x-auto"></pre>
                </div>

                <div>
                    <h3 class="text-lg font-bold text-white mb-2">Response Body</h3>
                    <pre id="responseBody" class="bg-gray-900 p-4 rounded text-gray-300 text-sm overflow-x-auto"></pre>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-6 border border-blue-500">
            <h2 class="text-2xl font-bold text-white mb-4">
                <i class="fas fa-history text-blue-400 mr-2"></i>
                Derni√®res Requ√™tes
            </h2>
            <div id="recentRequests" class="space-y-3">
                <!-- Les requ√™tes r√©centes seront ins√©r√©es ici -->
            </div>
        </div>
    </div>

    <script>
        async function sendRequest() {
            const method = document.getElementById('method').value;
            const url = document.getElementById('url').value;
            const headersText = document.getElementById('headers').value;
            const bodyText = document.getElementById('body').value;

            // Parse headers
            const headers = {};
            headersText.split('\n').forEach(line => {
                const [key, ...valueParts] = line.split(':');
                if (key && valueParts.length > 0) {
                    headers[key.trim()] = valueParts.join(':').trim();
                }
            });

            // Parse body
            let body = null;
            if (bodyText && method !== 'GET') {
                try {
                    body = JSON.parse(bodyText);
                    headers['Content-Type'] = 'application/json';
                } catch (e) {
                    body = bodyText;
                }
            }

            const startTime = Date.now();
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: headers,
                    body: body ? JSON.stringify(body) : null
                });

                const responseTime = Date.now() - startTime;
                const responseData = await response.text();

                // Affichage de la r√©ponse
                document.getElementById('responseSection').classList.remove('hidden');
                document.getElementById('statusCode').textContent = response.status;
                document.getElementById('statusCode').className = response.ok ? 
                    'text-2xl font-bold text-green-400' : 'text-2xl font-bold text-red-400';
                document.getElementById('responseTime').textContent = responseTime + 'ms';
                
                const responseHeaders = {};
                response.headers.forEach((value, key) => {
                    responseHeaders[key] = value;
                });
                document.getElementById('responseHeaders').textContent = JSON.stringify(responseHeaders, null, 2);

                try {
                    const json = JSON.parse(responseData);
                    document.getElementById('responseBody').textContent = JSON.stringify(json, null, 2);
                } catch (e) {
                    document.getElementById('responseBody').textContent = responseData;
                }

                // Scroll vers la r√©ponse
                document.getElementById('responseSection').scrollIntoView({ behavior: 'smooth' });
                
                // Recharger les requ√™tes r√©centes
                loadRecentRequests();
            } catch (error) {
                alert('Erreur lors de la requ√™te: ' + error.message);
            }
        }

        function loadRecentRequests() {
            fetch('/api/logs')
                .then(res => res.json())
                .then(logs => {
                    const html = logs.slice(0, 10).map(log => `
                        <div class="bg-gray-700 p-4 rounded hover:bg-gray-600 transition-all cursor-pointer"
                            onclick='fillFromLog(${JSON.stringify(log)})'>
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-3">
                                    <span class="px-2 py-1 rounded bg-blue-600 text-white text-xs font-semibold">
                                        ${log.method}
                                    </span>
                                    <span class="text-white font-mono text-sm">${log.url}</span>
                                </div>
                                <span class="text-gray-400 text-xs">${new Date(log.timestamp).toLocaleTimeString('fr-FR')}</span>
                            </div>
                            <div class="text-gray-400 text-xs">
                                Cliquez pour reproduire cette requ√™te
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('recentRequests').innerHTML = html || 
                        '<p class="text-gray-400">Aucune requ√™te r√©cente</p>';
                });
        }

        function fillFromLog(log) {
            document.getElementById('method').value = log.method;
            document.getElementById('url').value = log.url;
            
            const headersArray = Object.entries(log.headers)
                .filter(([key]) => !key.startsWith(':'))
                .map(([key, value]) => `${key}: ${value}`);
            document.getElementById('headers').value = headersArray.join('\n');
            
            if (log.body && Object.keys(log.body).length > 0) {
                document.getElementById('body').value = JSON.stringify(log.body, null, 2);
            }

            // Scroll vers le formulaire
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Chargement initial
        loadRecentRequests();
        
        // Rafra√Æchissement automatique
        setInterval(loadRecentRequests, 10000);
    </script>
</body>
</html>
